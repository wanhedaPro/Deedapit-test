<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deedapit Bakery POS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3f0;
        }
        .container {
            max-width: 1200px;
        }
        .active-tab {
            border-bottom: 2px solid #a855f7;
            color: #a855f7;
        }
        .scrollable-content {
            height: calc(100vh - 250px);
            overflow-y: auto;
        }
        /* Custom scrollbar for better UX */
        .scrollable-content::-webkit-scrollbar,
        #cart-list::-webkit-scrollbar,
        #order-details-content::-webkit-scrollbar,
        #customer-history-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track,
        #cart-list::-webkit-scrollbar-track,
        #order-details-content::-webkit-scrollbar-track,
        #customer-history-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb,
        #cart-list::-webkit-scrollbar-thumb,
        #order-details-content::-webkit-scrollbar-thumb,
        #customer-history-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover,
        #cart-list::-webkit-scrollbar-thumb:hover,
        #order-details-content::-webkit-scrollbar-thumb:hover,
        #customer-history-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container bg-white rounded-2xl shadow-xl p-8 m-4">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">Deedapit Bakery POS</h1>
            <div class="mt-4 md:mt-0 flex gap-4">
                <button id="cashier-btn" class="text-gray-600 hover:text-purple-600 transition-colors duration-200 font-medium pb-2 active-tab">Cashier</button>
                <button id="admin-btn" class="text-gray-600 hover:text-purple-600 transition-colors duration-200 font-medium pb-2">Admin</button>
            </div>
        </header>

        <div id="cashier-view" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 bg-gray-50 rounded-lg p-6 shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Order Taking</h2>
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="menu-cards">
                    </div>
            </div>

            <div class="md:col-span-1 bg-white rounded-lg p-6 shadow-md border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Cart</h2>
                <ul id="cart-list" class="space-y-4 max-h-60 overflow-y-auto mb-4">
                    </ul>
                <div class="text-lg font-bold text-gray-800 mt-4 mb-4">
                    Total: <span id="cart-total">RM 0.00</span>
                </div>
                <div class="mt-4">
                    <label for="order-type" class="block text-sm font-medium text-gray-700">Order Type</label>
                    <select id="order-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                        <option value="walk-in">Walk-in</option>
                        <option value="online">Online</option>
                    </select>
                </div>
                <div class="mt-4">
                    <label for="customer-contact" class="block text-sm font-medium text-gray-700">Customer Contact (Optional)</label>
                    <input type="text" id="customer-contact-input" placeholder="e.g. 0123456789" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                </div>
                <div class="mt-4">
                    <label for="customer-name" class="block text-sm font-medium text-gray-700">Customer Name (Optional)</label>
                    <input type="text" id="customer-name-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <input type="checkbox" id="pre-order-toggle" class="rounded text-purple-600 focus:ring-purple-500">
                    <label for="pre-order-toggle" class="text-sm font-medium text-gray-700">Pre-Order</label>
                </div>
                <div id="pre-order-date-time" class="mt-4 hidden">
                    <label for="pre-order-date" class="block text-sm font-medium text-gray-700">Pre-Order Date</label>
                    <input type="date" id="pre-order-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                    <label for="pre-order-time" class="block text-sm font-medium text-gray-700 mt-2">Pre-Order Time</label>
                    <input type="time" id="pre-order-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                    <label for="deposit-input" class="block text-sm font-medium text-gray-700 mt-2">Deposit (RM)</label>
                    <input type="number" step="0.01" id="deposit-input" placeholder="e.g. 5.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500">
                </div>
                <div class="flex gap-4 mt-6">
                    <button id="save-order-btn" class="flex-1 bg-purple-600 text-white font-bold py-3 px-4 rounded-md shadow-lg hover:bg-purple-700 transition-colors duration-200">
                        <span id="save-btn-text">Save Order</span>
                    </button>
                    <button id="clear-cart-btn" class="bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-md shadow-lg hover:bg-gray-300 transition-colors duration-200">Clear</button>
                </div>
                <button id="view-calendar-btn" class="mt-4 w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-md shadow-lg hover:bg-blue-600 transition-colors duration-200">View Pre-orders</button>
            </div>
        </div>

        <div id="admin-view" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Admin Dashboard</h2>
            <div class="flex border-b border-gray-200 mb-6">
                <button id="sales-tab" class="py-2 px-4 font-medium text-gray-600 hover:text-purple-600 transition-colors duration-200 active-tab">Sales Records</button>
                <button id="expenses-tab" class="py-2 px-4 font-medium text-gray-600 hover:text-purple-600 transition-colors duration-200">Manage Expenses</button>
                <button id="menu-tab" class="py-2 px-4 font-medium text-gray-600 hover:text-purple-600 transition-colors duration-200">Manage Menu</button>
                <button id="customers-tab" class="py-2 px-4 font-medium text-gray-600 hover:text-purple-600 transition-colors duration-200">Manage Customers</button>
            </div>
            <div id="sales-content" class="scrollable-content p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Sales Records</h3>
                    <div class="flex space-x-2">
                        <button id="sales-filter-daily" class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium py-1 px-3 rounded-full">Daily</button>
                        <button id="sales-filter-monthly" class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium py-1 px-3 rounded-full">Monthly</button>
                        <button id="sales-filter-yearly" class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium py-1 px-3 rounded-full">Yearly</button>
                        <button id="export-sales-btn" class="bg-green-500 text-white font-medium py-1 px-3 rounded-full hover:bg-green-600">Export</button>
                    </div>
                </div>
                <div id="sales-records-list">
                    </div>
            </div>
            
            <div id="expenses-content" class="hidden scrollable-content p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Manage Expenses</h3>
                    <button id="export-expenses-btn" class="bg-green-500 text-white font-medium py-1 px-3 rounded-full hover:bg-green-600">Export</button>
                </div>
                <form id="add-expense-form" class="bg-white p-4 rounded-lg shadow-sm mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="expense-name" class="block text-sm font-medium text-gray-700">Expense Name</label>
                            <input type="text" id="expense-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="expense-price" class="block text-sm font-medium text-gray-700">Price (RM)</label>
                            <input type="number" step="0.01" id="expense-price" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="expense-unit" class="block text-sm font-medium text-gray-700">Unit (kg, pcs, etc)</label>
                            <input type="text" id="expense-unit" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="expense-quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                            <input type="number" step="0.01" id="expense-quantity" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                    </div>
                    <button type="submit" class="mt-4 bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-700 transition-colors">Add Expense</button>
                </form>
                <div id="expenses-list">
                    </div>
            </div>

            <div id="menu-content" class="hidden scrollable-content p-4">
                <h3 class="text-xl font-semibold mb-4">Manage Menu</h3>
                <form id="add-menu-item-form" class="bg-white p-4 rounded-lg shadow-sm mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="item-name" class="block text-sm font-medium text-gray-700">Item Name</label>
                            <input type="text" id="item-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="item-price" class="block text-sm font-medium text-gray-700">Price (RM)</label>
                            <input type="number" step="0.01" id="item-price" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="item-image" class="block text-sm font-medium text-gray-700">Image URL</label>
                            <input type="text" id="item-image" placeholder="Paste image link here" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                    </div>
                    <button type="submit" id="add-menu-item-btn" class="mt-4 bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-700 transition-colors">Add Menu Item</button>
                </form>
                <div id="menu-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    </div>
            </div>

            <div id="customers-content" class="hidden scrollable-content p-4">
                <h3 class="text-xl font-semibold mb-4">Customer Records</h3>
                <div id="customer-list">
                    </div>
            </div>
        </div>
    </div>

    <div id="orderDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h3 class="text-xl font-bold">Order Details</h3>
                <button id="closeOrderDetailsModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div id="orderDetailsContent" class="max-h-96 overflow-y-auto">
                </div>
        </div>
    </div>
    
    <div id="customerHistoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h3 class="text-xl font-bold">Customer History</h3>
                <button id="closeCustomerHistoryModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div id="customerHistoryContent" class="max-h-96 overflow-y-auto">
                </div>
        </div>
    </div>
    
    <div id="calendarModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h3 class="text-xl font-bold">Pre-Order Calendar</h3>
                <button id="closeCalendarModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div id="calendar-view">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, where, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
              apiKey: "AIzaSyC3hgjIg2p7k2rt-vWJE8V9zdvxl8z6YrY",
              authDomain: "deedapit-812cc.firebaseapp.com",
              projectId: "deedapit-812cc",
              storageBucket: "deedapit-812cc.firebasestorage.app",
              messagingSenderId: "372463730148",
              appId: "1:372463730148:web:6776c5c464f22d768b5bf1",
              measurementId: "G-HYWC5Q8YBX"
        };
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const cashierBtn = document.getElementById('cashier-btn');
        const adminBtn = document.getElementById('admin-btn');
        const cashierView = document.getElementById('cashier-view');
        const adminView = document.getElementById('admin-view');
        const salesTab = document.getElementById('sales-tab');
        const expensesTab = document.getElementById('expenses-tab');
        const menuTab = document.getElementById('menu-tab');
        const customersTab = document.getElementById('customers-tab');
        const salesContent = document.getElementById('sales-content');
        const expensesContent = document.getElementById('expenses-content');
        const menuContent = document.getElementById('menu-content');
        const customersContent = document.getElementById('customers-content');
        const menuCards = document.getElementById('menu-cards');
        const cartList = document.getElementById('cart-list');
        const cartTotalSpan = document.getElementById('cart-total');
        const preOrderToggle = document.getElementById('pre-order-toggle');
        const preOrderDateTime = document.getElementById('pre-order-date-time');
        const saveOrderBtn = document.getElementById('save-order-btn');
        const clearCartBtn = document.getElementById('clear-cart-btn');
        const salesRecordsList = document.getElementById('sales-records-list');
        const expensesList = document.getElementById('expenses-list');
        const menuList = document.getElementById('menu-list');
        const customerList = document.getElementById('customer-list');
        const addExpenseForm = document.getElementById('add-expense-form');
        const addMenuItemForm = document.getElementById('add-menu-item-form');
        const salesFilterDailyBtn = document.getElementById('sales-filter-daily');
        const salesFilterMonthlyBtn = document.getElementById('sales-filter-monthly');
        const salesFilterYearlyBtn = document.getElementById('sales-filter-yearly');
        const exportSalesBtn = document.getElementById('export-sales-btn');
        const exportExpensesBtn = document.getElementById('export-expenses-btn');
        const viewCalendarBtn = document.getElementById('view-calendar-btn');
        const calendarModal = document.getElementById('calendarModal');
        const closeCalendarModalBtn = document.getElementById('closeCalendarModalBtn');
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const closeOrderDetailsModalBtn = document.getElementById('closeOrderDetailsModalBtn');
        const orderDetailsContent = document.getElementById('orderDetailsContent');
        const customerHistoryModal = document.getElementById('customerHistoryModal');
        const closeCustomerHistoryModalBtn = document.getElementById('closeCustomerHistoryModalBtn');
        const customerHistoryContent = document.getElementById('customerHistoryContent');

        // --- State Variables ---
        let cart = [];
        let menuItems = [];
        let salesRecords = [];
        let expensesRecords = [];
        let preOrderRecords = [];
        let currentSalesFilter = 'daily';

        // --- View Switching Logic ---
        function showView(view) {
            cashierView.classList.add('hidden');
            adminView.classList.add('hidden');
            document.querySelectorAll('.active-tab').forEach(el => el.classList.remove('active-tab'));

            if (view === 'cashier') {
                cashierView.classList.remove('hidden');
                cashierBtn.classList.add('active-tab');
            } else if (view === 'admin') {
                adminView.classList.remove('hidden');
                adminBtn.classList.add('active-tab');
                showAdminTab('sales');
            }
        }

        function showAdminTab(tab) {
            salesContent.classList.add('hidden');
            expensesContent.classList.add('hidden');
            menuContent.classList.add('hidden');
            customersContent.classList.add('hidden');
            document.querySelectorAll('#admin-view button').forEach(el => el.classList.remove('active-tab'));

            switch (tab) {
                case 'sales':
                    salesContent.classList.remove('hidden');
                    salesTab.classList.add('active-tab');
                    fetchSalesRecords();
                    break;
                case 'expenses':
                    expensesContent.classList.remove('hidden');
                    expensesTab.classList.add('active-tab');
                    fetchExpenses();
                    break;
                case 'menu':
                    menuContent.classList.remove('hidden');
                    menuTab.classList.add('active-tab');
                    fetchMenuItems();
                    break;
                case 'customers':
                    customersContent.classList.remove('hidden');
                    customersTab.classList.add('active-tab');
                    fetchCustomers();
                    break;
            }
        }

        // --- Data Fetching from Firestore ---
        async function fetchMenuItems() {
            try {
                const q = query(collection(db, "menuItems"));
                const querySnapshot = await getDocs(q);
                menuItems = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMenuCards();
                renderMenuList();
            } catch (e) {
                console.error("Error fetching menu items: ", e);
            }
        }

        async function fetchSalesRecords(filter = currentSalesFilter) {
            let records = [];
            let q = collection(db, "salesRecords");
            
            // Filtering logic
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const startOfPeriod = new Date();

            switch (filter) {
                case 'daily':
                    startOfPeriod.setHours(0, 0, 0, 0);
                    break;
                case 'monthly':
                    startOfPeriod.setDate(1);
                    startOfPeriod.setHours(0, 0, 0, 0);
                    break;
                case 'yearly':
                    startOfPeriod.setMonth(0);
                    startOfPeriod.setDate(1);
                    startOfPeriod.setHours(0, 0, 0, 0);
                    break;
            }

            q = query(q, where("timestamp", ">=", startOfPeriod));
            
            try {
                const querySnapshot = await getDocs(q);
                records = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                salesRecords = records.sort((a, b) => b.timestamp - a.timestamp); // Sort by most recent
                renderSalesRecords();
            } catch (e) {
                console.error("Error fetching sales records: ", e);
            }
        }

        async function fetchExpenses() {
            try {
                const q = query(collection(db, "expenses"));
                const querySnapshot = await getDocs(q);
                expensesRecords = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderExpenses();
            } catch (e) {
                console.error("Error fetching expenses: ", e);
            }
        }

        async function fetchCustomers() {
            try {
                const salesSnapshot = await getDocs(collection(db, "salesRecords"));
                const preOrdersSnapshot = await getDocs(collection(db, "preOrders"));
                const allOrders = [...salesSnapshot.docs, ...preOrdersSnapshot.docs];
                
                const uniqueCustomers = {};
                allOrders.forEach(doc => {
                    const data = doc.data();
                    if (data.customerContact) {
                        uniqueCustomers[data.customerContact] = {
                            name: data.customerName,
                            contact: data.customerContact
                        };
                    }
                });

                const customers = Object.values(uniqueCustomers);
                renderCustomers(customers);
            } catch (e) {
                console.error("Error fetching customers: ", e);
            }
        }

        async function fetchPreOrders() {
            try {
                const q = query(collection(db, "preOrders"), where("completed", "==", false));
                const querySnapshot = await getDocs(q);
                preOrderRecords = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCalendar();
            } catch (e) {
                console.error("Error fetching pre-orders: ", e);
            }
        }

        // --- Data Rendering ---
        function renderMenuCards() {
            menuCards.innerHTML = '';
            menuItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow duration-200';
                card.innerHTML = `
                    <img src="${item.image || 'https://via.placeholder.com/150'}" alt="${item.name}" class="w-full h-32 object-cover rounded-md mb-2">
                    <h3 class="font-semibold text-lg">${item.name}</h3>
                    <p class="text-gray-600">RM ${item.price.toFixed(2)}</p>
                `;
                card.addEventListener('click', () => addItemToCart(item));
                menuCards.appendChild(card);
            });
        }

        function renderCart() {
            cartList.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                cartList.innerHTML = '<li class="text-gray-500 text-center">Cart is empty</li>';
            } else {
                cart.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-md';
                    listItem.innerHTML = `
                        <div class="flex-1">
                            <h4 class="font-medium">${item.name}</h4>
                            <p class="text-sm text-gray-600">RM ${item.price.toFixed(2)} x ${item.quantity}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-id="${item.id}" data-action="decrement" class="bg-gray-200 text-gray-700 w-6 h-6 rounded-full">-</button>
                            <span class="font-bold">${item.quantity}</span>
                            <button data-id="${item.id}" data-action="increment" class="bg-gray-200 text-gray-700 w-6 h-6 rounded-full">+</button>
                            <button data-id="${item.id}" data-action="remove" class="text-red-500 ml-2">&times;</button>
                        </div>
                    `;
                    cartList.appendChild(listItem);
                    total += item.price * item.quantity;
                });
            }
            cartTotalSpan.textContent = `RM ${total.toFixed(2)}`;
        }

        function renderSalesRecords() {
            salesRecordsList.innerHTML = '';
            if (salesRecords.length === 0) {
                salesRecordsList.innerHTML = '<p class="text-center text-gray-500">No sales records found for this period.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full text-left table-auto';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">Date</th>
                        <th class="py-3 px-6 text-left">Order ID</th>
                        <th class="py-3 px-6 text-left">Total</th>
                        <th class="py-3 px-6 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 text-sm font-light"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            salesRecords.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                const date = new Date(record.timestamp.seconds * 1000).toLocaleString();
                row.innerHTML = `
                    <td class="py-3 px-6 whitespace-nowrap">${date}</td>
                    <td class="py-3 px-6">${record.id}</td>
                    <td class="py-3 px-6">RM ${record.total.toFixed(2)}</td>
                    <td class="py-3 px-6 text-center">
                        <button data-id="${record.id}" data-action="view-sales" class="text-sm bg-blue-500 text-white py-1 px-2 rounded hover:bg-blue-600">View</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            salesRecordsList.appendChild(table);
        }

        function renderExpenses() {
            expensesList.innerHTML = '';
            if (expensesRecords.length === 0) {
                expensesList.innerHTML = '<p class="text-center text-gray-500">No expenses records found.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full text-left table-auto';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">Date</th>
                        <th class="py-3 px-6 text-left">Name</th>
                        <th class="py-3 px-6 text-left">Total</th>
                        <th class="py-3 px-6 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 text-sm font-light"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            expensesRecords.forEach(expense => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                const date = new Date(expense.timestamp.seconds * 1000).toLocaleDateString();
                row.innerHTML = `
                    <td class="py-3 px-6 whitespace-nowrap">${date}</td>
                    <td class="py-3 px-6">${expense.name}</td>
                    <td class="py-3 px-6">RM ${expense.total.toFixed(2)}</td>
                    <td class="py-3 px-6 text-center">
                        <button data-id="${expense.id}" data-action="delete-expense" class="text-sm bg-red-500 text-white py-1 px-2 rounded hover:bg-red-600">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            expensesList.appendChild(table);
        }

        function renderMenuList() {
            menuList.innerHTML = '';
            menuItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md';
                card.innerHTML = `
                    <img src="${item.image || 'https://via.placeholder.com/150'}" alt="${item.name}" class="w-full h-24 object-cover rounded-md mb-2">
                    <h4 class="font-semibold text-md">${item.name}</h4>
                    <p class="text-gray-600 text-sm">RM ${item.price.toFixed(2)}</p>
                    <button data-id="${item.id}" data-action="delete-menu-item" class="mt-2 text-sm bg-red-500 text-white py-1 px-2 rounded hover:bg-red-600">Delete</button>
                `;
                menuList.appendChild(card);
            });
        }

        function renderCustomers(customers) {
            customerList.innerHTML = '';
            if (customers.length === 0) {
                customerList.innerHTML = '<p class="text-center text-gray-500">No customer records found.</p>';
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full text-left table-auto';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">Name</th>
                        <th class="py-3 px-6 text-left">Contact</th>
                        <th class="py-3 px-6 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 text-sm font-light"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-6 whitespace-nowrap">${customer.name || 'N/A'}</td>
                    <td class="py-3 px-6">${customer.contact || 'N/A'}</td>
                    <td class="py-3 px-6 text-center">
                        <button data-contact="${customer.contact}" data-action="view-history" class="text-sm bg-blue-500 text-white py-1 px-2 rounded hover:bg-blue-600">View History</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            customerList.appendChild(table);
        }

        function renderCalendar() {
            const calendarEl = document.getElementById('calendar-view');
            calendarEl.innerHTML = '';
            
            const groupedByDate = preOrderRecords.reduce((acc, order) => {
                const dateKey = order.preOrderDate;
                if (!acc[dateKey]) {
                    acc[dateKey] = [];
                }
                acc[dateKey].push(order);
                return acc;
            }, {});

            if (Object.keys(groupedByDate).length === 0) {
                calendarEl.innerHTML = '<p class="text-center text-gray-500">No pending pre-orders.</p>';
                return;
            }
            
            for (const date in groupedByDate) {
                const dateHeader = document.createElement('h4');
                dateHeader.className = 'text-lg font-bold mt-4 mb-2';
                dateHeader.textContent = new Date(date).toDateString();
                calendarEl.appendChild(dateHeader);

                const list = document.createElement('ul');
                list.className = 'space-y-2';
                groupedByDate[date].forEach(order => {
                    const listItem = document.createElement('li');
                    listItem.className = 'bg-gray-100 p-3 rounded-md flex justify-between items-center';
                    listItem.innerHTML = `
                        <div>
                            <p class="font-medium">${order.customerName || 'N/A'}</p>
                            <p class="text-sm text-gray-600">${order.preOrderTime || 'N/A'} - RM ${order.total.toFixed(2)}</p>
                            <p class="text-xs text-gray-400">Deposit: RM ${order.deposit.toFixed(2)}</p>
                        </div>
                        <button data-id="${order.id}" data-action="complete-pre-order" class="text-sm bg-green-500 text-white py-1 px-2 rounded hover:bg-green-600">Complete</button>
                    `;
                    list.appendChild(listItem);
                });
                calendarEl.appendChild(list);
            }
        }

        // --- Cart and Order Logic ---
        function addItemToCart(item) {
            const existingItem = cart.find(cartItem => cartItem.id === item.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...item, quantity: 1 });
            }
            renderCart();
        }

        function handleCartAction(event) {
            const { id, action } = event.target.dataset;
            const item = cart.find(cartItem => cartItem.id === id);
            if (!item) return;

            if (action === 'increment') {
                item.quantity++;
            } else if (action === 'decrement') {
                if (item.quantity > 1) {
                    item.quantity--;
                } else {
                    cart = cart.filter(cartItem => cartItem.id !== id);
                }
            } else if (action === 'remove') {
                cart = cart.filter(cartItem => cartItem.id !== id);
            }
            renderCart();
        }

        async function saveOrder() {
            if (cart.length === 0) {
                alert('Cart is empty. Please add items to save an order.');
                return;
            }

            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const orderType = document.getElementById('order-type').value;
            const customerContact = document.getElementById('customer-contact-input').value;
            const customerName = document.getElementById('customer-name-input').value;
            const isPreOrder = preOrderToggle.checked;
            const orderData = {
                items: cart.map(item => ({ id: item.id, name: item.name, price: item.price, quantity: item.quantity })),
                total,
                orderType,
                customerContact: customerContact || null,
                customerName: customerName || null,
                timestamp: new Date()
            };

            try {
                if (isPreOrder) {
                    const preOrderDate = document.getElementById('pre-order-date').value;
                    const preOrderTime = document.getElementById('pre-order-time').value;
                    const deposit = parseFloat(document.getElementById('deposit-input').value) || 0;
                    if (!preOrderDate || !preOrderTime) {
                        alert('Pre-order date and time are required.');
                        return;
                    }
                    await addDoc(collection(db, "preOrders"), {
                        ...orderData,
                        preOrderDate,
                        preOrderTime,
                        deposit,
                        completed: false
                    });
                    alert('Pre-order saved successfully!');
                } else {
                    await addDoc(collection(db, "salesRecords"), orderData);
                    alert('Order saved successfully!');
                }
                clearCart();
            } catch (e) {
                console.error("Error saving document: ", e);
                alert('An error occurred while saving the order. Please try again.');
            }
        }

        function clearCart() {
            cart = [];
            renderCart();
            document.getElementById('order-type').value = 'walk-in';
            document.getElementById('customer-contact-input').value = '';
            document.getElementById('customer-name-input').value = '';
            preOrderToggle.checked = false;
            preOrderDateTime.classList.add('hidden');
        }

        // --- Admin Actions ---
        async function saveExpense(event) {
            event.preventDefault();
            const name = document.getElementById('expense-name').value;
            const price = parseFloat(document.getElementById('expense-price').value);
            const unit = document.getElementById('expense-unit').value;
            const quantity = parseFloat(document.getElementById('expense-quantity').value);
            const total = price * quantity;

            if (isNaN(total)) {
                alert('Please enter valid numbers for price and quantity.');
                return;
            }

            try {
                await addDoc(collection(db, "expenses"), {
                    name,
                    price,
                    unit,
                    quantity,
                    total,
                    timestamp: new Date()
                });
                alert('Expense added successfully!');
                addExpenseForm.reset();
                fetchExpenses(); // Refresh the list
            } catch (e) {
                console.error("Error adding expense: ", e);
                alert('Error adding expense. Please try again.');
            }
        }

        async function deleteExpense(expenseId) {
            if (confirm('Are you sure you want to delete this expense record?')) {
                try {
                    await deleteDoc(doc(db, "expenses", expenseId));
                    alert('Expense deleted successfully!');
                    fetchExpenses();
                } catch (e) {
                    console.error("Error deleting expense: ", e);
                    alert('Error deleting expense. Please try again.');
                }
            }
        }
        
        async function saveMenuItem(event) {
            event.preventDefault();
            const name = document.getElementById('item-name').value;
            const price = parseFloat(document.getElementById('item-price').value);
            const image = document.getElementById('item-image').value;

            if (isNaN(price)) {
                alert('Please enter a valid price.');
                return;
            }

            try {
                await addDoc(collection(db, "menuItems"), {
                    name,
                    price,
                    image
                });
                alert('Menu item added successfully!');
                addMenuItemForm.reset();
                fetchMenuItems(); // Refresh the menu
            } catch (e) {
                console.error("Error adding menu item: ", e);
                alert('Error adding menu item. Please try again.');
            }
        }

        async function deleteMenuItem(itemId) {
            if (confirm('Are you sure you want to delete this menu item?')) {
                try {
                    await deleteDoc(doc(db, "menuItems", itemId));
                    alert('Menu item deleted successfully!');
                    fetchMenuItems();
                } catch (e) {
                    console.error("Error deleting menu item: ", e);
                    alert('Error deleting menu item. Please try again.');
                }
            }
        }

        async function viewSalesDetails(orderId) {
            try {
                const docRef = doc(db, "salesRecords", orderId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const itemsHtml = data.items.map(item => `
                        <div class="border-b border-gray-200 py-2">
                            <p class="font-medium">${item.name} x ${item.quantity}</p>
                            <p class="text-sm text-gray-600">RM ${item.price.toFixed(2)} each</p>
                        </div>
                    `).join('');
                    orderDetailsContent.innerHTML = `
                        <p><strong>Order ID:</strong> ${orderId}</p>
                        <p><strong>Date:</strong> ${new Date(data.timestamp.seconds * 1000).toLocaleString()}</p>
                        <p><strong>Total:</strong> RM ${data.total.toFixed(2)}</p>
                        <p><strong>Customer Name:</strong> ${data.customerName || 'N/A'}</p>
                        <p><strong>Customer Contact:</strong> ${data.customerContact || 'N/A'}</p>
                        <h4 class="font-bold mt-4">Items:</h4>
                        ${itemsHtml}
                    `;
                    orderDetailsModal.classList.remove('hidden');
                    orderDetailsModal.classList.add('flex');
                } else {
                    alert("No such order found!");
                }
            } catch (e) {
                console.error("Error fetching order details: ", e);
                alert('Error fetching order details.');
            }
        }
        
        async function viewCustomerHistory(customerContact) {
            try {
                const salesQ = query(collection(db, "salesRecords"), where("customerContact", "==", customerContact));
                const preOrderQ = query(collection(db, "preOrders"), where("customerContact", "==", customerContact));
                
                const salesSnapshot = await getDocs(salesQ);
                const preOrderSnapshot = await getDocs(preOrderQ);
                
                const history = [...salesSnapshot.docs, ...preOrderSnapshot.docs].map(doc => doc.data());
                history.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);

                customerHistoryContent.innerHTML = '';
                if (history.length === 0) {
                    customerHistoryContent.innerHTML = '<p class="text-center text-gray-500">No purchase history found for this customer.</p>';
                } else {
                    const table = document.createElement('table');
                    table.className = 'w-full text-left table-auto';
                    table.innerHTML = `
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Date</th>
                                <th class="py-3 px-6 text-left">Total</th>
                                <th class="py-3 px-6 text-left">Type</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light"></tbody>
                    `;
                    const tbody = table.querySelector('tbody');
                    history.forEach(record => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-100';
                        row.innerHTML = `
                            <td class="py-3 px-6 whitespace-nowrap">${new Date(record.timestamp.seconds * 1000).toLocaleString()}</td>
                            <td class="py-3 px-6">RM ${record.total.toFixed(2)}</td>
                            <td class="py-3 px-6">${record.preOrderDate ? 'Pre-order' : 'Walk-in/Online'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    customerHistoryContent.appendChild(table);
                }
                customerHistoryModal.classList.remove('hidden');
                customerHistoryModal.classList.add('flex');
            } catch (e) {
                console.error("Error fetching customer history: ", e);
                alert('Error fetching customer history.');
            }
        }

        async function completePreOrder(orderId) {
            if (confirm('Mark this pre-order as completed?')) {
                try {
                    const orderRef = doc(db, "preOrders", orderId);
                    await updateDoc(orderRef, {
                        completed: true
                    });
                    alert('Pre-order marked as complete!');
                    fetchPreOrders(); // Refresh calendar
                } catch (e) {
                    console.error("Error completing pre-order: ", e);
                    alert('Error completing pre-order. Please try again.');
                }
            }
        }

        // --- Export to CSV ---
        function exportToCsv(data, filename) {
            const replacer = (key, value) => value === null ? '' : value;
            const header = Object.keys(data[0]);
            let csv = data.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(','));
            csv.unshift(header.join(','));
            csv = csv.join('\r\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, filename);
        }

        // --- Event Listeners ---
        cashierBtn.addEventListener('click', () => showView('cashier'));
        adminBtn.addEventListener('click', () => showView('admin'));
        salesTab.addEventListener('click', () => showAdminTab('sales'));
        expensesTab.addEventListener('click', () => showAdminTab('expenses'));
        menuTab.addEventListener('click', () => showAdminTab('menu'));
        customersTab.addEventListener('click', () => showAdminTab('customers'));

        preOrderToggle.addEventListener('change', () => {
            if (preOrderToggle.checked) {
                preOrderDateTime.classList.remove('hidden');
            } else {
                preOrderDateTime.classList.add('hidden');
            }
        });

        cartList.addEventListener('click', handleCartAction);
        saveOrderBtn.addEventListener('click', saveOrder);
        clearCartBtn.addEventListener('click', clearCart);
        addExpenseForm.addEventListener('submit', saveExpense);
        addMenuItemForm.addEventListener('submit', saveMenuItem);

        salesRecordsList.addEventListener('click', (e) => {
            const { id, action } = e.target.dataset;
            if (action === 'view-sales') {
                viewSalesDetails(id);
            }
        });

        expensesList.addEventListener('click', (e) => {
            const { id, action } = e.target.dataset;
            if (action === 'delete-expense') {
                deleteExpense(id);
            }
        });
        
        menuList.addEventListener('click', (e) => {
            const { id, action } = e.target.dataset;
            if (action === 'delete-menu-item') {
                deleteMenuItem(id);
            }
        });

        salesFilterDailyBtn.addEventListener('click', () => {
            currentSalesFilter = 'daily';
            fetchSalesRecords('daily');
        });
        salesFilterMonthlyBtn.addEventListener('click', () => {
            currentSalesFilter = 'monthly';
            fetchSalesRecords('monthly');
        });
        salesFilterYearlyBtn.addEventListener('click', () => {
            currentSalesFilter = 'yearly';
            fetchSalesRecords('yearly');
        });

        exportSalesBtn.addEventListener('click', () => {
            const csvData = salesRecords.map(s => ({
                date: new Date(s.timestamp.seconds * 1000).toLocaleDateString(),
                total: s.total,
                orderType: s.orderType,
                customerName: s.customerName || '',
                customerContact: s.customerContact || ''
            }));
            exportToCsv(csvData, 'sales_records.csv');
        });

        exportExpensesBtn.addEventListener('click', () => {
            const csvData = expensesRecords.map(e => ({
                date: new Date(e.timestamp.seconds * 1000).toLocaleDateString(),
                name: e.name,
                price: e.price,
                unit: e.unit,
                quantity: e.quantity,
                total: e.total
            }));
            exportToCsv(csvData, 'expenses_records.csv');
        });

        viewCalendarBtn.addEventListener('click', () => {
            fetchPreOrders();
            calendarModal.classList.remove('hidden');
            calendarModal.classList.add('flex');
        });

        closeCalendarModalBtn.addEventListener('click', () => {
            calendarModal.classList.remove('flex');
            calendarModal.classList.add('hidden');
        });

        closeOrderDetailsModalBtn.addEventListener('click', () => {
            orderDetailsModal.classList.remove('flex');
            orderDetailsModal.classList.add('hidden');
        });
        
        closeCustomerHistoryModalBtn.addEventListener('click', () => {
            customerHistoryModal.classList.remove('flex');
            customerHistoryModal.classList.add('hidden');
        });
        
        customerList.addEventListener('click', (e) => {
            const { contact, action } = e.target.dataset;
            if (action === 'view-history') {
                viewCustomerHistory(contact);
            }
        });

        // Event listener for pre-order completion in the calendar modal
        calendarModal.addEventListener('click', (e) => {
            const { id, action } = e.target.dataset;
            if (action === 'complete-pre-order') {
                completePreOrder(id);
            }
        });


        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            showView('cashier'); // Start with cashier view
            fetchMenuItems(); // Fetch menu on load
        });

        // Listeners for changes in Firebase
        onSnapshot(collection(db, "menuItems"), (snapshot) => {
            menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderMenuCards();
            renderMenuList();
        });

        onSnapshot(collection(db, "salesRecords"), () => {
            fetchSalesRecords(currentSalesFilter);
        });

        onSnapshot(collection(db, "expenses"), () => {
            fetchExpenses();
        });

        // The customer listener is intentionally removed as customer data is now fetched from sales/pre-order records on demand.
        // This is a more efficient approach given the current data structure.

        onSnapshot(collection(db, "preOrders"), () => {
            fetchPreOrders();
        });

    </script>
</body>
</html>
